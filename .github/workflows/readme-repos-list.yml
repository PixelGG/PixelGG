name: Update Projects in README

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * 1"   # Wöchentlich (Montag 00:00 UTC)
  workflow_dispatch:       # Manuell im Actions-Tab startbar

jobs:
  update-projects:
    runs-on: ubuntu-latest

    env:
      OWNER: ${{ github.repository_owner }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generate public repos list (sorted by activity)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - << 'PY'
          import os, json, urllib.request, pathlib, html

          owner = os.environ["OWNER"]
          token = os.environ["GITHUB_TOKEN"]

          url = f"https://api.github.com/users/{owner}/repos?per_page=100&sort=pushed&direction=desc"
          req = urllib.request.Request(
              url,
              headers={
                  "Authorization": f"Bearer {token}",
                  "Accept": "application/vnd.github+json",
                  "User-Agent": "update-projects-readme",
              },
          )
          with urllib.request.urlopen(req) as resp:
              data = json.load(resp)

          # Nur öffentliche Repos ohne Forks, Profil-Repo explizit rausfiltern
          excluded_fullname = f"{owner}/{owner}".lower()
          repos = [
              r for r in data
              if (not r.get("private"))
              and (not r.get("fork"))
              and r.get("full_name", "").lower() != excluded_fullname
          ]

          max_repos = 6
          repos = repos[:max_repos]

          if not repos:
              md_block = "_Noch keine öffentlichen Repositories mit Aktivität._"
          else:
              # 2-Spalten-Grid mit kleinen „Cards“
              cells = []
              for r in repos:
                  name = html.escape(r["name"])
                  html_url = r["html_url"]
                  desc = (r.get("description") or "").strip()
                  desc = html.escape(desc) if desc else "&nbsp;"

                  cell = (
                      '<td valign="top" width="50%" style="padding: 8px;">'
                      f'<a href="{html_url}"><strong>{name}</strong></a><br/>'
                      f'<sub>{desc}</sub>'
                      "</td>"
                  )
                  cells.append(cell)

              rows = []
              for i in range(0, len(cells), 2):
                  row_cells = cells[i:i+2]
                  if len(row_cells) == 1:
                      # Für ungerade Anzahl eine leere rechte Spalte einsetzen
                      row_cells.append('<td valign="top" width="50%" style="padding: 8px;"></td>')
                  rows.append("<tr>" + "".join(row_cells) + "</tr>")

              table_html = (
                  '<table align="center">\n' +
                  "\n".join(rows) +
                  "\n</table>"
              )
              md_block = table_html

          path = pathlib.Path("README.md")
          text = path.read_text(encoding="utf-8")

          start_marker = "<!-- start: projects-list -->"
          end_marker = "<!-- end: projects-list -->"

          try:
              start_idx = text.index(start_marker)
              end_idx = text.index(end_marker, start_idx)
          except ValueError:
              raise SystemExit("Marker <!-- start: projects-list --> / <!-- end: projects-list --> nicht gefunden.")

          new_text = (
              text[: start_idx + len(start_marker)]
              + "\n\n"
              + md_block
              + "\n\n"
              + text[end_idx:]
          )
          path.write_text(new_text, encoding="utf-8")
          PY

      - name: Commit and push changes (if any)
        run: |
          if git diff --quiet; then
            echo "Keine Änderungen an README.md"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update projects list in README [skip ci]"
          git push
